
from urllib.parse import quote_plus
from django.shortcuts import redirect   # asegÃºrate de tener este import

def checkout(request):
    """
    En lugar de renderizar una pÃ¡gina de pago,
    arma un mensaje con el carrito y redirige a WhatsApp.
    """
    items = []
    total = 0

    # Intento 1: si usas una clase Cart iterable (cart.cart.Cart)
    try:
        from cart.cart import Cart
        cart = Cart(request)
        for it in cart:
            # intenta obtener nombre, cantidad y precio de forma segura
            producto = it.get("product") or it.get("producto")
            name = getattr(producto, "name", None) or it.get("name", "Producto")
            qty = int(it.get("quantity") or it.get("qty") or 1)
            price = float(it.get("price") or getattr(producto, "price", 0) or 0)
            subtotal = qty * price
            total += subtotal
            items.append(f"- {qty} Ã— {name} (â‚¡{int(price):,})")
    except Exception:
        # Intento 2: si el carrito estÃ¡ en sesiÃ³n como dict
        cart_data = request.session.get("cart", {}) or request.session.get("CART", {})
        for pid, info in cart_data.items():
            name = info.get("name") or info.get("nombre") or f"Producto {pid}"
            qty = int(info.get("quantity") or info.get("qty") or 1)
            price = float(info.get("price") or info.get("precio") or 0)
            subtotal = qty * price
            total += subtotal
            items.append(f"- {qty} Ã— {name} (â‚¡{int(price):,})")

    if not items:
        items.append("(Carrito vacÃ­o)")

    # Mensaje a enviar por WhatsApp
    lineas = [
        "Hola, quiero hacer un pedido desde la web:",
        *items,
        f"Total estimado: â‚¡{int(total):,}",
        "",
        "Â¿Me ayudan a coordinar el pago y la entrega? ðŸ˜Š",
    ]
    texto = quote_plus("\n".join(lineas))

    # âœ… NÃºmero de la carnicerÃ­a
    wa_url = f"https://wa.me/50670381223?text={texto}"

    return redirect(wa_url)
