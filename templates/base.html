{% load static %}

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Carnes del Rancho{% endblock %}</title>

  <!-- Favicons -->
  <link rel="icon" href="{% static 'img/iconNav.png' %}">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Vendor CSS -->
  <link href="{% static 'assets/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/aos/aos.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/swiper/swiper-bundle.min.css' %}" rel="stylesheet">

  <!-- Main CSS -->
  <link href="{% static 'assets/css/main.css' %}?v=2" rel="stylesheet">

  {% block extra_css %}{% endblock %}

  <!-- Oculta preloader si existiera -->
  <style>#preloader{display:none!important;visibility:hidden!important;}</style>
</head>

<body class="{% block body_class %}{% endblock %}">

  <!-- ==== HEADER / NAV (consistente en todo el sitio) ==== -->
  <header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">

      <a href="{% url 'home' %}#hero" class="logo d-flex align-items-center me-auto me-xl-0">
        <img src="{% static 'img/toro.png' %}" alt="Icono toro" style="height:40px;margin-right:10px;">
        <h1 class="sitename m-0">Carnes del Rancho</h1>
      </a>

      <nav id="navmenu" class="navmenu">
        <ul>
          <li><a href="{% url 'home' %}#hero">Inicio</a></li>
          <li><a href="{% url 'home' %}#about">Sobre Nosotros</a></li>
          <li><a href="{% url 'home' %}#menu">Catálogo de Productos</a></li>
          <li><a href="{% url 'home' %}#contact">Contacto</a></li>
        </ul>
        <i class="mobile-nav-toggle d-xl-none bi bi-list" aria-label="Abrir menú"></i>
      </nav>

      <a class="btn-getstarted d-none d-sm-block" href="{% url 'orders:checkout' %}">Comprar</a>
    </div>
  </header>

  <!-- Mensajes flash Django -->
  {% if messages %}
    <div class="container my-3">
      {% for m in messages %}
        <div class="alert alert-{{ m.tags|default:'info' }} mb-0">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- ==== OFFCANVAS CARRITO (DEBE IR DENTRO DEL BODY) ==== -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel" style="width:420px;max-width:100%;">
    <div id="cartOffcanvasInner"><!-- contenido AJAX --></div>
  </div>

  <!-- ==== CONTENIDO DE CADA PÁGINA ==== -->
  <main id="main">
    {% block content %}{% endblock %}
  </main>

  <!-- ==== FOOTER ==== -->
  <footer id="footer" class="footer mt-5">
    <div class="container footer-top">
      <div class="row gy-4">
        <div class="col-lg-5 col-md-12 footer-about">
          <a href="/" class="logo d-flex align-items-center">
            <span class="sitename">Carnes del Rancho</span>
          </a>
          <p>
            Ofrecemos los mejores cortes de res, cerdo y pollo, huevos frescos del rancho y embutidos artesanales.
            Frescura, higiene y atención personalizada para cada cliente.
          </p>
          <div class="social-links d-flex mt-4">
            <a href="https://www.facebook.com/carnesdelranchocq" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
            <a href="https://www.instagram.com/carnesdelranchocq/" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
            <a href="https://wa.me/50670381223" target="_blank" rel="noopener">70381223</a>

          </div>
        </div>

        <div class="col-lg-2 col-6 footer-links">
          <h4>Enlaces útiles</h4>
          <ul>
            <li><a href="{% url 'home' %}#hero">Inicio</a></li>
            <li><a href="{% url 'home' %}#about">Sobre Nosotros</a></li>
            <li><a href="{% url 'home' %}#menu">Catálogo</a></li>
            <li><a href="{% url 'home' %}#contact">Contáctenos</a></li>
            <li><a href="#">Política de Privacidad</a></li>
          </ul>
        </div>

        <div class="col-lg-2 col-6 footer-links">
          <h4>Servicios</h4>
          <ul>
            <li><a href="#">Venta de carnes frescas</a></li>
            <li><a href="#">Cortes premium a pedido</a></li>
            <li><a href="#">Embutidos artesanales</a></li>
            <li><a href="#">Huevos del rancho</a></li>
            <li><a href="#">Pedidos por WhatsApp</a></li>
          </ul>
        </div>

        <div class="col-lg-3 col-md-12 footer-contact text-center text-md-start">
          <h4>Contáctenos</h4>
          <p>Carnes del Rancho</p>
          <p>Ciudad Quesada, San Carlos</p>
          <p>Alajuela, Costa Rica</p>
          <p class="mt-4"><strong>Teléfono:</strong> <span>70381223</span></p>
          <p><strong>Correo:</strong> <span>carnesdelrancho@gmail.com</span></p>
          <p><strong>Horario:</strong> Lunes a sábado, 8:00 a.m. – 7:00 p.m.</p>
        </div>
      </div>
    </div>

    <div class="container copyright text-center mt-4">
      <p><strong class="px-1 sitename">Carnes del Rancho</strong> &copy; {% now "Y" %}</p>
    </div>
  </footer>

  <!-- WhatsApp flotante -->
  <a
    href="https://api.whatsapp.com/send?phone=50670381223&text=Hola%20quiero%20hacer%20un%20pedido"
    target="_blank" rel="noopener" aria-label="WhatsApp Carnes del Rancho"
    style="position: fixed; right: 35px; bottom: 50px; width: 50px; height: 50px; border-radius: 50%;
           background:#25D366; color:#fff; display:inline-flex; align-items:center; justify-content:center;
           text-decoration:none; box-shadow:0 6px 16px rgba(0,0,0,.25); z-index:2147483647;">
    <i class="bi bi-whatsapp" style="font-size:28px;line-height:0;"></i>
  </a>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
    <i class="bi bi-arrow-up-short"></i>
  </a>

  <!-- Vendor JS (orden importa) -->
  <script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'assets/vendor/aos/aos.js' %}"></script>
  <script src="{% static 'assets/vendor/swiper/swiper-bundle.min.js' %}"></script>

  <!-- Main JS -->
  <script src="{% static 'assets/js/main.js' %}"></script>

  <!-- ==== JS del OFFCANVAS del carrito (mantengo tu lógica) ==== -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Intercepta formularios de "agregar al carrito"
    document.body.addEventListener('submit', async function (e) {
      const form = e.target;
      if (!form.matches('.js-cart-add')) return;  // solo los marcados
      e.preventDefault();

      try {
        // Enviar el POST normal (mantiene lógica/seguridad server-side)
        const resp = await fetch(form.action, {
          method: 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!resp.ok) throw new Error('Error al agregar');

        // Pedir el panel renderizado
        const panel = await fetch("{% url 'cart:cart_panel' %}", { headers: { 'X-Requested-With': 'XMLHttpRequest' }});
        const data = await panel.json();
        document.getElementById('cartOffcanvasInner').innerHTML = data.html;

        // Mostrar offcanvas
        const el = document.getElementById('cartOffcanvas');
        const off = bootstrap.Offcanvas.getOrCreateInstance(el);
        off.show();
      } catch (err) {
        console.error(err);
        alert('No se pudo agregar al carrito. Intenta de nuevo.');
      }
    });
  });
  </script>

  {% block extra_js %}{% endblock %}

  <!-- Fallback por si main.js no corre -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var pre = document.getElementById('preloader');
      if (pre) pre.style.display = 'none';
      document.body.classList.remove('overflow-hidden');
    });
  </script>
</body>
</html>
